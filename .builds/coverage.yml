image: ubuntu/lts
secrets:
  - 46f739e5-4538-45dd-a79f-bf173b7a2ed9
sources:
  - git@git.sr.ht:~asko/dompa
tasks:
  - bootstrap: |
      sudo apt update && sudo apt upgrade -y
      sudo apt-get install software-properties-common rlwrap curl zip unzip -y
      sudo apt update
      curl -L -O https://github.com/clojure/brew-install/releases/latest/download/linux-install.sh
      chmod +x linux-install.sh
      sudo ./linux-install.sh
      curl -s "https://get.sdkman.io" | bash
      source ~/.sdkman/bin/sdkman-init.sh
      sdk install java

  - coverage: |
      source ~/.sdkman/bin/sdkman-init.sh
      cd ./dompa
      clj -M:coverage

  - gen-badge: |
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
      source ~/.nvm/nvm.sh
      nvm install --lts
      npm i -g lcov-badge2
      lcov-badge2 -o coverage.svg target/coverage/lcov.info

  - upload-badge: |
      eval "$(ssh-agent -s)"
      ssh-add ~/.ssh/id_rsa
      ssh-keyscan git.sr.ht >> ~/.ssh/known_hosts
      git clone git@git.sr.ht:~asko/dompa-resources
      mv coverage.svg dompa-resources/coverage.svg
      cd dompa-resources
      git add .
      git commit -m "Update"
      git push -u origin master